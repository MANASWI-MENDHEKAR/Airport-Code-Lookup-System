<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úàÔ∏è Airport Information System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-label {
            color: #333(255, 255, 255, 0.8);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #718096, #4a5568);
        }

        .results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .airport-result {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .airport-result:hover {
            background: #edf2f7;
        }

        .airport-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .airport-details {
            color: #4a5568;
            font-size: 0.9em;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .distance-result {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .distance-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .distance-numbers {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 15px;
        }

        .distance-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
            font-size: 0.9em;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .nearby-airports {
            max-height: 300px;
            overflow-y: auto;
        }

        .nearby-airport {
            background: #f7fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
            padding: 10px;
        }

        .error {
            background: #fed7d7;
            color: #c53030;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .help-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .help-item {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
        }

        .help-item h4 {
            color: #2d3748;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-item ul {
            list-style: none;
            padding-left: 0;
        }

        .help-item li {
            padding: 5px 0;
            color: #4a5568;
        }

        .help-item li:before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-item h3 {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto; /* Enable scroll if content is too long */
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh; /* Limit height and allow scrolling */
            overflow-y: auto;
            position: relative; /* For close button positioning */
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }

        .close:hover {
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Complete Airport Information System</h1>
            <p>Global Airport Database - Search, Calculate & Explore</p>
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalAirports">Loading...</div>
                    <div class="stat-label">Total Airports</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCountries">Loading...</div>
                    <div class="stat-label">Countries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalCities">Loading...</div>
                    <div class="stat-label">Cities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTimezones">Loading...</div>
                    <div class="stat-label">Unique Timezones</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>üîç Airport Search & Lookup</h2>
                <input type="text" class="search-box" id="searchInput" placeholder="Enter airport code (JFK), city (New York), or airport name...">
                <button class="btn" onclick="searchAirports()">Search Airports</button>
                <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
                
                <div class="results" id="searchResults"></div>
            </div>

            <div class="card">
                <h2>üìè Distance Calculator</h2>
                <input type="text" class="search-box" id="airport1" placeholder="From airport (e.g., JFK)">
                <input type="text" class="search-box" id="airport2" placeholder="To airport (e.g., LAX)">
                <button class="btn" onclick="calculateDistance()">Calculate Distance</button>
                
                <div id="distanceResults"></div>
            </div>
        </div>

        <div class="card">
            <h2>üöÄ Advanced Features</h2>
            <div class="tabs">
                <button class="tab active" onclick="showTab('nearby')">üåç Nearby Airports</button>
                <button class="tab" onclick="showTab('country')">üè≥Ô∏è Country Airports</button>
                <button class="tab" onclick="showTab('statistics')">üìä Statistics</button>
            </div>

            <div id="nearby" class="tab-content active">
                <input type="text" class="search-box" id="nearbyAirport" placeholder="Enter airport code (e.g., JFK)">
                <input type="number" class="search-box" id="radius" placeholder="Radius in km (default: 100)" value="100">
                <button class="btn" onclick="findNearbyAirports()">Find Nearby Airports</button>
                <div class="results" id="nearbyResults"></div>
            </div>

            <div id="country" class="tab-content">
                <input type="text" class="search-box" id="countryInput" placeholder="Enter country name (e.g., United States)">
                <button class="btn" onclick="getCountryAirports()">Get Country Airports</button>
                <div class="results" id="countryResults"></div>
            </div>

            <div id="statistics" class="tab-content">
                <button class="btn" onclick="generateStatistics()">Generate Global Statistics</button>
                <button class="btn btn-secondary" onclick="generateCountryStats()">Country Rankings</button>
                <div class="results" id="statisticsResults"></div>
            </div>
        </div>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-icon">üîç</div>
                <h3>Smart Search</h3>
                <p>Search by IATA codes, ICAO codes, city names, or airport names with intelligent matching</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üìè</div>
                <h3>Distance Calculator</h3>
                <p>Calculate great circle distances between any two airports with flight time estimates</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üåç</div>
                <h3>Location Tools</h3>
                <p>Find nearby airports within any radius and explore airport locations worldwide</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üìä</div>
                <h3>Statistics & Reports</h3>
                <p>Comprehensive analytics and reports on global airport distribution and data</p>
            </div>
        </div>

        <div class="help-section">
            <h2>üí° Help & Usage Tips</h2>
            <div class="help-grid">
                <div class="help-item">
                    <h4>üîç Search Tips</h4>
                    <ul>
                        <li>Use IATA codes (3 letters): LAX, JFK, LHR</li>
                        <li>Use ICAO codes (4 letters): KLAX, KJFK, EGLL</li>
                        <li>Search by airport name: "Los Angeles"</li>
                        <li>Search by city: "London"</li>
                        <li>Partial matches work: "Kennedy" finds JFK</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h4>üìè Distance Calculator</h4>
                    <ul>
                        <li>Enter any two airport codes</li>
                        <li>Results show both km and miles</li>
                        <li>Includes estimated flight time</li>
                        <li>Uses precise haversine formula</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h4>üåç Location Features</h4>
                    <ul>
                        <li>Find airports within specified radius</li>
                        <li>Default radius is 100km</li>
                        <li>Results sorted by distance</li>
                        <li>View detailed coordinates</li>
                    </ul>
                </div>
                <div class="help-item">
                    <h4>‚å®Ô∏è General Tips</h4>
                    <ul>
                        <li>Airport codes are case-insensitive</li>
                        <li>Click results for detailed information</li>
                        <li>Use clear search to reset results</li>
                        <li>All calculations use real-time data</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="airportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="airportDetails"></div>
        </div>
    </div>

    <script>
        // Global variables to store airport data and loading status
        let airportData = [];
        let isDataLoaded = false;

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            // event.target is the button that was clicked
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
        }

        // Function to load airport data from JSON file
        async function loadAirportData() {
            showLoading('totalAirports'); // Show loading in stats
            showLoading('totalCountries');
            showLoading('totalCities');
            showLoading('totalTimezones');

            try {
                const response = await fetch('airports.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                airportData = await response.json();
                isDataLoaded = true;
                console.log('Airport data loaded successfully:', airportData.length, 'airports');
                updateStatistics(); // Update the upper boxes with real data
            } catch (error) {
                console.error('Error loading airport data:', error);
                showError('searchResults', 'Failed to load airport data. Please ensure "airports.json" is in the correct directory and is valid JSON. See console for details.');
                document.getElementById('totalAirports').textContent = 'Error';
                document.getElementById('totalCountries').textContent = 'Error';
                document.getElementById('totalCities').textContent = 'Error';
                document.getElementById('totalTimezones').textContent = 'Error';
            }
        }

        // Function to update the statistics in the header boxes
        function updateStatistics() {
            // This check should now always be true as data loads
            if (!isDataLoaded) return; 

            const totalAirports = airportData.length;

            // Filter out null, undefined, empty strings, and explicitly '\N' from unique counts
            // 'c => c' handles null, undefined, and empty string ("")
            // '&& c !== '\\N'' specifically excludes the string literal "\N"
            const countries = new Set(airportData.map(airport => airport.country).filter(c => c && c !== '\\N'));
            const totalCountries = countries.size;

            const cities = new Set(airportData.map(airport => airport.city).filter(c => c && c !== '\\N'));
            const totalCities = cities.size;

            const timezones = new Set(airportData.map(airport => airport.timezone).filter(t => t && t !== '\\N'));
            const totalTimezones = timezones.size;

            // IMPORTANT: Add these console.log statements to your function to see the actual values
            // This will help you verify what numbers are being calculated for each statistic.
            console.log("--- Update Statistics Report ---");
            console.log("Total Airports (calculated):", totalAirports);
            console.log("Total Countries (calculated):", totalCountries, "Unique Countries:", Array.from(countries));
            console.log("Total Cities (calculated):", totalCities, "Unique Cities:", Array.from(cities));
            console.log("Total Timezones (calculated):", totalTimezones, "Unique Timezones:", Array.from(timezones));
            console.log("--------------------------------");

            // Update the HTML elements
            document.getElementById('totalAirports').textContent = totalAirports.toLocaleString();
            document.getElementById('totalCountries').textContent = totalCountries.toLocaleString();
            document.getElementById('totalCities').textContent = totalCities.toLocaleString();
            document.getElementById('totalTimezones').textContent = totalTimezones.toLocaleString();
        }

        // Search airports
        function searchAirports() {
            if (!isDataLoaded) {
                showError('searchResults', 'Airport data is still loading. Please wait...');
                return;
            }

            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showError('searchResults', 'Please enter a search query');
                return;
            }

            const results = smartSearch(query);
            displaySearchResults(results, query);
        }

        // Smart search function
        function smartSearch(query) {
            query = query.toLowerCase().trim();
            let results = [];
            const processedIata = new Set(); // To avoid duplicates

            // Search by IATA/ICAO code (exact match first)
            const codeMatch = airportData.find(airport => 
                (airport.iata && airport.iata.toLowerCase() === query) || 
                (airport.icao && airport.icao.toLowerCase() === query)
            );
            if (codeMatch) {
                results.push(codeMatch);
                processedIata.add(codeMatch.iata);
            }

            // Filter for other matches, avoiding duplicates
            const otherMatches = airportData.filter(airport => {
                if (processedIata.has(airport.iata)) return false; // Skip if already added by exact code match

                return (airport.city && airport.city.toLowerCase().includes(query)) || 
                       (airport.country && airport.country.toLowerCase().includes(query)) || 
                       (airport.name && airport.name.toLowerCase().includes(query));
            });
            results = results.concat(otherMatches);

            return results;
        }

        // Display search results
        function displaySearchResults(results, query) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = `<div class="error">‚ùå No airports found for "${query}"</div>`;
                return;
            }

            let html = `<div class="success">üîç Found ${results.length} airport(s) for "${query}":</div>`;
            
            results.forEach(airport => {
                html += `
                    <div class="airport-result" onclick="showAirportDetails('${airport.iata || airport.icao}')">
                        <div class="airport-name">${airport.name || 'N/A'} (${airport.iata || 'N/A'})</div>
                        <div class="airport-details">
                            <div>üìç ${airport.city || 'N/A'}, ${airport.country || 'N/A'}</div>
                            <div>üåç ${airport.latitude ? airport.latitude.toFixed(4) : 'N/A'}, ${airport.longitude ? airport.longitude.toFixed(4) : 'N/A'}</div>
                            <div>üî§ ICAO: ${airport.icao || 'N/A'}</div>
                            <div>‚õ∞Ô∏è Elevation: ${airport.elevation !== null && airport.elevation !== undefined ? airport.elevation + ' ft' : 'N/A'}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show detailed airport information in modal
        function showAirportDetails(code) {
            const airport = findAirport(code);
            if (!airport) {
                console.error('Airport not found for details:', code);
                return;
            }

            const html = `
                <h2>‚úàÔ∏è ${airport.name || 'N/A'}</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h3>üìç Location</h3>
                        <p><strong>City:</strong> ${airport.city || 'N/A'}</p>
                        <p><strong>Country:</strong> ${airport.country || 'N/A'}</p>
                        <p><strong>Coordinates:</strong> ${airport.latitude ? airport.latitude.toFixed(6) : 'N/A'}, ${airport.longitude ? airport.longitude.toFixed(6) : 'N/A'}</p>
                        <p><strong>Elevation:</strong> ${airport.elevation !== null && airport.elevation !== undefined ? airport.elevation + ' ft (' + Math.round(airport.elevation * 0.3048) + ' m)' : 'N/A'}</p>
                    </div>
                    <div>
                        <h3>üè∑Ô∏è Codes & Info</h3>
                        <p><strong>IATA Code:</strong> ${airport.iata || 'N/A'}</p>
                        <p><strong>ICAO Code:</strong> ${airport.icao || 'N/A'}</p>
                        <p><strong>Timezone:</strong> ${airport.timezone || 'N/A'}</p>
                        <p><strong>Current Time:</strong> ${airport.timezone ? getCurrentTime(airport.timezone) : 'N/A'}</p>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn" onclick="useInCalculator('${airport.iata || airport.icao}', 1)">Use as Origin</button>
                    <button class="btn" onclick="useInCalculator('${airport.iata || airport.icao}', 2)">Use as Destination</button>
                    <button class="btn btn-secondary" onclick="findNearbyForAirport('${airport.iata || airport.icao}')">Find Nearby</button>
                </div>
            `;

            document.getElementById('airportDetails').innerHTML = html;
            document.getElementById('airportModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('airportModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('airportModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Use airport in distance calculator
        function useInCalculator(code, field) {
            document.getElementById('airport' + field).value = code;
            closeModal();
            // Scroll to distance calculator
            document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth' });
        }

        // Find nearby airports for a specific airport
        function findNearbyForAirport(code) {
            document.getElementById('nearbyAirport').value = code;
            showTab('nearby');
            closeModal();
            findNearbyAirports();
        }

        // Get current time for timezone (simplified)
        function getCurrentTime(timezone) {
            try {
                return new Date().toLocaleString('en-US', { timeZone: timezone });
            } catch (e) {
                return 'Invalid Timezone';
            }
        }

        // Calculate distance between airports
        function calculateDistance() {
            if (!isDataLoaded) {
                showError('distanceResults', 'Airport data is still loading. Please wait...');
                return;
            }
            const airport1Code = document.getElementById('airport1').value.trim().toUpperCase();
            const airport2Code = document.getElementById('airport2').value.trim().toUpperCase();

            if (!airport1Code || !airport2Code) {
                showError('distanceResults', 'Please enter both airport codes');
                return;
            }

            if (airport1Code === airport2Code) {
                showError('distanceResults', 'Please enter different airports');
                return;
            }

            const airport1 = findAirport(airport1Code);
            const airport2 = findAirport(airport2Code);

            if (!airport1 || !airport1.latitude || !airport1.longitude) {
                showError('distanceResults', `Airport "${airport1Code}" not found or missing coordinates`);
                return;
            }

            if (!airport2 || !airport2.latitude || !airport2.longitude) {
                showError('distanceResults', `Airport "${airport2Code}" not found or missing coordinates`);
                return;
            }

            const distance = calculateHaversineDistance(
                airport1.latitude, airport1.longitude,
                airport2.latitude, airport2.longitude
            );

            const flightTime = estimateFlightTime(distance);

            const html = `
                <div class="distance-result">
                    <h3>‚úàÔ∏è Distance Calculation Results</h3>
                    <div class="distance-info">
                        <div>
                            <h4>üìç From: ${airport1.name || 'N/A'} (${airport1Code})</h4>
                            <p>${airport1.city || 'N/A'}, ${airport1.country || 'N/A'}</p>
                        </div>
                        <div>
                            <h4>üìç To: ${airport2.name || 'N/A'} (${airport2Code})</h4>
                            <p>${airport2.city || 'N/A'}, ${airport2.country || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="distance-numbers">
                        <div class="distance-value">${distance.km.toFixed(0)} km</div>
                        <div class="distance-value">${distance.miles.toFixed(0)} miles</div>
                        <div class="distance-value">${distance.nauticalMiles.toFixed(0)} nm</div>
                        <div style="margin-top: 15px;">
                            <div>üïí Estimated Flight Time: ${flightTime}</div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('distanceResults').innerHTML = html;
        }

        // Find airport by IATA or ICAO code
        function findAirport(code) {
            if (!isDataLoaded) return null;
            code = code.toUpperCase();
            return airportData.find(airport => 
                (airport.iata && airport.iata.toUpperCase() === code) || 
                (airport.icao && airport.icao.toUpperCase() === code)
            );
        }

        // Calculate haversine distance between two points
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = toRadians(lat2 - lat1);
            const dLon = toRadians(lon2 - lon1);
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const km = R * c;
            
            return {
                km: km,
                miles: km * 0.621371,
                nauticalMiles: km * 0.539957
            };
        }

        // Convert degrees to radians
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // Estimate flight time based on distance
        function estimateFlightTime(distance) {
            const avgSpeed = 850; // Average commercial flight speed in km/h
            const hours = distance.km / avgSpeed;
            
            if (hours < 1) {
                return `${Math.round(hours * 60)} minutes`;
            } else if (hours < 24) {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return m > 0 ? `${h}h ${m}m` : `${h}h`;
            } else {
                return `${Math.round(hours)} hours`;
            }
        }

        // Find nearby airports
        function findNearbyAirports() {
            if (!isDataLoaded) {
                showError('nearbyResults', 'Airport data is still loading. Please wait...');
                return;
            }
            const airportCode = document.getElementById('nearbyAirport').value.trim().toUpperCase();
            const radius = parseInt(document.getElementById('radius').value) || 100;

            if (!airportCode) {
                showError('nearbyResults', 'Please enter an airport code');
                return;
            }

            const centralAirport = findAirport(airportCode);
            if (!centralAirport || !centralAirport.latitude || !centralAirport.longitude) {
                showError('nearbyResults', `Airport "${airportCode}" not found or missing coordinates`);
                return;
            }

            const nearbyAirports = [];
            
            airportData.forEach(airport => {
                // Ensure airport has coordinates and is not the central airport itself
                if (airport.iata !== centralAirport.iata && airport.latitude && airport.longitude) {
                    const distance = calculateHaversineDistance(
                        centralAirport.latitude, centralAirport.longitude,
                        airport.latitude, airport.longitude
                    );
                    
                    if (distance.km <= radius) {
                        nearbyAirports.push({
                            ...airport,
                            distance: distance
                        });
                    }
                }
            });

            // Sort by distance
            nearbyAirports.sort((a, b) => a.distance.km - b.distance.km);

            displayNearbyResults(nearbyAirports, centralAirport, radius);
        }

        // Display nearby airports results
        function displayNearbyResults(airports, centralAirport, radius) {
            const container = document.getElementById('nearbyResults');
            
            if (airports.length === 0) {
                container.innerHTML = `
                    <div class="error">
                        ‚ùå No airports found within ${radius}km of ${centralAirport.name || 'N/A'} (${centralAirport.iata || 'N/A'})
                    </div>
                `;
                return;
            }

            let html = `
                <div class="success">
                    üåç Found ${airports.length} airport(s) within ${radius}km of ${centralAirport.name || 'N/A'} (${centralAirport.iata || 'N/A'}):
                </div>
                <div class="nearby-airports">
            `;

            airports.forEach(airport => {
                html += `
                    <div class="nearby-airport" onclick="showAirportDetails('${airport.iata || airport.icao}')">
                        <div>
                            <strong>${airport.name || 'N/A'} (${airport.iata || 'N/A'})</strong><br>
                            <small>${airport.city || 'N/A'}, ${airport.country || 'N/A'}</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${airport.distance.km.toFixed(1)} km</strong><br>
                            <small>${airport.distance.miles.toFixed(1)} miles</small>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Get airports by country
        function getCountryAirports() {
            if (!isDataLoaded) {
                showError('countryResults', 'Airport data is still loading. Please wait...');
                return;
            }
            const country = document.getElementById('countryInput').value.trim();
            if (!country) {
                showError('countryResults', 'Please enter a country name');
                return;
            }

            const countryAirports = airportData.filter(airport =>
                airport.country && airport.country.toLowerCase().includes(country.toLowerCase())
            );

            displayCountryResults(countryAirports, country);
        }

        // Display country airports results
        function displayCountryResults(airports, country) {
            const container = document.getElementById('countryResults');
            
            if (airports.length === 0) {
                container.innerHTML = `<div class="error">‚ùå No airports found for "${country}"</div>`;
                return;
            }

            let html = `<div class="success">üè≥Ô∏è Found ${airports.length} airport(s) in "${country}":</div>`;
            
            airports.forEach(airport => {
                html += `
                    <div class="airport-result" onclick="showAirportDetails('${airport.iata || airport.icao}')">
                        <div class="airport-name">${airport.name || 'N/A'} (${airport.iata || 'N/A'})</div>
                        <div class="airport-details">
                            <div>üìç ${airport.city || 'N/A'}</div>
                            <div>üî§ ICAO: ${airport.icao || 'N/A'}</div>
                            <div>üåç ${airport.latitude ? airport.latitude.toFixed(4) : 'N/A'}, ${airport.longitude ? airport.longitude.toFixed(4) : 'N/A'}</div>
                            <div>‚õ∞Ô∏è ${airport.elevation !== null && airport.elevation !== undefined ? airport.elevation + ' ft' : 'N/A'}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Generate global statistics
        function generateStatistics() {
            if (!isDataLoaded) {
                showError('statisticsResults', 'Airport data is still loading. Please wait...');
                return;
            }
            const stats = calculateGlobalStats();
            displayStatistics(stats);
        }

        // Calculate global statistics
        function calculateGlobalStats() {
            if (!isDataLoaded || airportData.length === 0) return null;
            
            const countries = [...new Set(airportData.map(a => a.country).filter(c => c))];
            const cities = [...new Set(airportData.map(a => a.city).filter(c => c))];
            
            const elevations = airportData.map(a => a.elevation).filter(e => e !== null && e !== undefined);
            const avgElevation = elevations.length > 0 ? elevations.reduce((a, b) => a + b) / elevations.length : 0;
            const maxElevation = elevations.length > 0 ? Math.max(...elevations) : 0;
            const minElevation = elevations.length > 0 ? Math.min(...elevations) : 0;

            const latitudes = airportData.map(a => a.latitude).filter(lat => lat !== null && lat !== undefined);
            const northernmost = latitudes.length > 0 ? airportData.find(a => a.latitude === Math.max(...latitudes)) : null;
            const southernmost = latitudes.length > 0 ? airportData.find(a => a.latitude === Math.min(...latitudes)) : null;

            return {
                totalAirports: airportData.length,
                totalCountries: countries.length,
                totalCities: cities.length,
                avgElevation: Math.round(avgElevation),
                maxElevation,
                minElevation,
                northernmost,
                southernmost,
                countries
            };
        }

        // Display statistics
        function displayStatistics(stats) {
            const container = document.getElementById('statisticsResults');
            
            if (!stats) {
                container.innerHTML = '<div class="error">‚ùå No data available for statistics</div>';
                return;
            }
            
            const html = `
                <div class="success">üìä Global Airport Statistics:</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <h3>${stats.totalAirports.toLocaleString()}</h3>
                        <p>Total Airports</p>
                    </div>
                    <div class="stat-item">
                        <h3>${stats.totalCountries.toLocaleString()}</h3>
                        <p>Countries</p>
                    </div>
                    <div class="stat-item">
                        <h3>${stats.totalCities.toLocaleString()}</h3>
                        <p>Cities</p>
                    </div>
                    <div class="stat-item">
                        <h3>${stats.avgElevation.toLocaleString()} ft</h3>
                        <p>Average Elevation</p>
                    </div>
                    <div class="stat-item">
                        <h3>${stats.maxElevation.toLocaleString()} ft</h3>
                        <p>Highest Airport</p>
                    </div>
                    <div class="stat-item">
                        <h3>${stats.minElevation.toLocaleString()} ft</h3>
                        <p>Lowest Airport</p>
                    </div>
                </div>
                ${stats.northernmost && stats.southernmost ? `
                <div style="margin-top: 20px;">
                    <div class="airport-result" onclick="showAirportDetails('${stats.northernmost.iata || stats.northernmost.icao}')">
                        <div class="airport-name">üîù Northernmost: ${stats.northernmost.name || 'N/A'}</div>
                        <div class="airport-details">
                            <div>üìç ${stats.northernmost.city || 'N/A'}, ${stats.northernmost.country || 'N/A'}</div>
                            <div>üåç ${stats.northernmost.latitude ? stats.northernmost.latitude.toFixed(4) + '¬∞N' : 'N/A'}</div>
                        </div>
                    </div>
                    <div class="airport-result" onclick="showAirportDetails('${stats.southernmost.iata || stats.southernmost.icao}')">
                        <div class="airport-name">üîª Southernmost: ${stats.southernmost.name || 'N/A'}</div>
                        <div class="airport-details">
                            <div>üìç ${stats.southernmost.city || 'N/A'}, ${stats.southernmost.country || 'N/A'}</div>
                            <div>üåç ${stats.southernmost.latitude ? Math.abs(stats.southernmost.latitude).toFixed(4) + '¬∞S' : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            container.innerHTML = html;
        }

        // Generate country rankings
        function generateCountryStats() {
            if (!isDataLoaded) {
                showError('statisticsResults', 'Airport data is still loading. Please wait...');
                return;
            }
            
            const countryStats = {};
            
            airportData.forEach(airport => {
                if (airport.country) {
                    if (!countryStats[airport.country]) {
                        countryStats[airport.country] = {
                            count: 0,
                            airports: []
                        };
                    }
                    countryStats[airport.country].count++;
                    countryStats[airport.country].airports.push(airport);
                }
            });

            const sortedCountries = Object.entries(countryStats)
                .sort(([,a], [,b]) => b.count - a.count);

            displayCountryStats(sortedCountries);
        }

        // Display country statistics
        function displayCountryStats(countries) {
            const container = document.getElementById('statisticsResults');
            
            let html = '<div class="success">üèÜ Country Rankings by Airport Count:</div>';
            
            countries.forEach(([country, data], index) => {
                html += `
                    <div class="airport-result">
                        <div class="airport-name">#${index + 1} ${country}</div>
                        <div class="airport-details">
                            <div>‚úàÔ∏è ${data.count} airports</div>
                            <div>üèôÔ∏è Cities: ${[...new Set(data.airports.map(a => a.city).filter(c => c))].join(', ')}</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Clear search results
        function clearResults() {
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchInput').value = '';
        }

        // Show error message
        function showError(containerId, message) {
            document.getElementById(containerId).innerHTML = `<div class="error">‚ùå ${message}</div>`;
        }

        // Show loading message
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = 'Loading...';
            }
        }

        // Enter key support for search boxes
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchAirports();
            });

            document.getElementById('airport1').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') calculateDistance();
            });

            document.getElementById('airport2').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') calculateDistance();
            });

            document.getElementById('nearbyAirport').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') findNearbyAirports();
            });

            document.getElementById('countryInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') getCountryAirports();
            });

            // Load airport data when page loads
            loadAirportData();
        });
    </script>
</body>
</html>